Sguil should be installed in the following order:

Step 1: Install mysql and create the sguil database.
Step 2: Install the GUI server (sguild).
Step 3: Install the GUI client (sguil.tk).
Step 4: Install the sensor.
Step 5: Install xscriptd.

NOTE: Everything can be installed on a single system,
or the different services can be split up between 
different systems. For instance, snort and barnyard
can be installed on one sytem (the sensor), the GUI
server and xscriptd on another system, the database
on yet another system, and the client could be run
on a number of different systems. The configuration
is flexible and the number of systems required depends
on the resources needed. Large networks will benefit
by splitting the different processes up on different
sytems, while a home user should easily be able to
run everything on a single system.

######################################################
#Step 1: Install mysql and create the sguil database.#
######################################################

Install mysql (http:www.mysql.com) per its installation
instructions. 

You can either now create the DB structure using the 
following methods, or skip to 'Installing sguild',
where it will create the structure for you on init.
NOTE: If you choose to let sguild create the DB for
you, then you must still use 'GRANT' to give priv-
ledges for each sensor.

Create the sguildb:
  Bamm@syn# mysql -u root -p -e "CREATE DATABASE sguildb"
Make sure each sensor has INSERT and SELECT privledges:
  Bamm@syn# mysql -u root -p -e "GRANT INSERT,SELECT on sguildb.* to root@<sensorip>"
Build the required tables:
  Bamm@syn# mysql -u root -p -D sguildb < ./server/sql_scripts/create_sguildb.sql
  *NOTE: Verify all is well with: mysql -u root -p -e "show tables"
  +-------------------+
  | Tables_in_sguildb |
  +-------------------+
  | data              |
  | event             |
  | history           |
  | icmphdr           |
  | portscan          |
  | sensor            |
  | sessions          |
  | status            |
  | tcphdr            |
  | udphdr            |
  | user_info         |
  | version           |
  +-------------------+

##########################################
#Step 2: Install the GUI server (sguild).#
##########################################
Sguild is a tcl script and I would recommend using tcl-8.3
or better. I haven't had time to test lesser versions but
they may work. 

1) Make sure tcl is installed along with the extended (tclx)
libs (http://tclx.sourceforge.net). Tclx is a common tcl
extensions and packages can be found for most OSes/distros.

2) Sguild requires mysqltcl support and it can
be downloaded from http://www.xdobry.de/mysqltcl/. Once
installed, test that it can be loaded by invoking the tcl
interpreter (ie /usr/bin/tcl or /usr/local/bin/tclsh8.3)
and adding the package:
  tcl> package require mysqltcl
  tcl>
If you receive no errors than all is good.

(NOTE: On OpenBSD you may need to add the line:
  load /usr/local/lib/libmysqltcl.so.0.0
prior to the line:
  package require mysqltcl
in order for the tcl/tk interpreter to find the package.)

3) Edit sguild so the first line contains the correct path to
the tcl interpreter (ie #!/usr/bin/tcl or #!/usr/local/bin/tclsh8.3).

4) Configure options within sguild.conf. Pay particular attention
to the PATH you define for sguild to look for snort rules.  In the
future, rules will be localized in the DB, for now each rule file
must be kept on the sguild server based on the hostname. Don't
forget to copy these rule files over after installing the sensor.

5) Add users to sguild.users file.

6) Start the daemon, it will send a query to the DB to get
any archived alerts and then echo "Sguild Initialized."


############################################
#Step 3: Install the GUI client (sguil.tk).#
############################################
Sguil.tk is a tcl/tk script. It requires tcl/tk 8.3 (I haven't tested
lesser versions, they may work), tclx 8.3 (I have heard that
some distros package tclx with the standard tcl libs), and incr tcl (itcl)
3.2 (including the iwidgets 2.2 set - see http://www.tcltk.com/iwidgets/
for more info).

On startup, sguil.tk reads the options in sguil.conf. If a path to
the sguil.conf file is not provided, it will look in the current dir
and /etc/sguil/sguil.conf by default. To specify the location for
the sguil.conf, start sguil.tk like so:
  Bamm@syn# ./sguil.tk -- -c <path>/sguil.conf
Explanations for the different options are within the default conf file.

Along with the config file, sguil.tk will also read $HOME/.sguilrc for
font information if it exists. Anytime you change the default font in
sguil.tk, it will write your new preferences to .sguilrc.


#############################
#Step 4: Install the sensor.#
#############################
A. Begin by installing snort -
  Download the source for snort from http://www.snort.org/dl. Untar
  the package, change to the preprocessors directory, and make a
  back up of the portscan and stream4 preprocessor:
    Bamm@syn# cd src/preprocessors
    Bamm@syn# cp spp_portscan.c spp_portscan.c.bak
    Bamm@syn# cp spp_stream4.c spp_stream4.c.bak
  Next copy the patch files from the sguil source tree to the snort
  source tree and patch the preprocessors:
    Bamm@syn# cp <sguil-src>/sensors/snort_mods/2_0/spp_portscan_sguil.patch .
    Bamm@syn# cp <sguil-src>/sensors/snort_mods/2_0/spp_stream4.patch .
    Bamm@syn# patch spp_portscan.c < spp_portscan_sguil.patch
    Bamm@syn# patch spp_stream4.c < spp_stream4_sguil.patch
  
  Then, compile and install snort as normal.

  Finally, configure snort to use the new portscan and stream4 preprocessors
  and the log_unified output plugin:

    Format for the portscan mod is:
      preprocessor portscan: $HOME_NET <ports> <secs> <logdir> <hostname>
        <logdir> must exists and will be read by portscan_loader.tcl
    EXAMPLE:
      preprocessor portscan: $HOME_NET 4 3 /snort_data/portscans syn

    Format for the stream4 (keepstats) mod is:
      keepstats db <log path>
    EXAMPLE:
      preprocessor stream4: detect_scans, disable_evasion_alerts, keepstats db /snort_data/ssn_logs
    
    Enable unified logging with this line:
      output log_unified: filename snort.log, limit 128

  Make sure all the config files for snort are copied to the appropriate
  directory (ie /etc/snort). 
    Bamm@syn# ls /etc/snort/
    gen-msg.map snort.conf classification.config reference.config sid-msg.map
  Start snort:
    Bamm@syn# snort -l /snort_data -c /etc/snort/snort.conf -D
  *NOTE: I use a seperate partition /snort_data to do all my logging.

B. Next install and start the sensor_agent.tcl from the ./sensor directory.
Make sure to point the script to the correct interpreter
(i.e. #!/usr/bin/tcl or #!/usr/local/bin/tclsh8.3) and to configure the
different options. The sensor agent forwards portscan and session data
files to sguild for loading to the DB.


C. Now install Barnyard -
  Download the source for barnyard from
   http://www.snort.org/dl/barnyard/barnyard-0.1.0.tar.gz.
  Untar the package and add the op_sguil plugin (op_sguil is a modifed op_acid_db
  plugin. Sorry Andrew, I really didn't mean to mangle your code that bad).
    Bamm@syn# cd barnyard/src/output-plugins
    Bamm@syn# cp <sguil-src>/sensor/barnyard_mods/op_sguil.* .
  Next run configure, and enable mysql support for barnyard it the root of the 
  source tree. (Use the "with" flags if your mysql libs are in a non-standard
  location.)
    Bamm@syn# cd <barnyard-src>
    Bamm@syn# ./configure --enable-mysql
  Then cd back into the output-plugins directory, edit the Makefile, and build
  the object files. This prevents the hand edited Makefile from being over-
  written during compilation.
    Bamm@syn# cd src/output-plugins
    Bamm@syn# vi Makefile
      Edit the file and append the following to the below variable definitions.
        libop_a_SOURCES = <blah> op_sguil.c op_sguil.h
        libop_a_OBJECTS = <blah> op_sguil.o
    Bamm@syn# vi op_plugbase.c
      Edit the file like so:
	~line 26:
           #ifdef ENABLE_MYSQL
           #include "op_acid_db.h"
           #include "op_sguil.h"
           #endif
        ~line 47:
           #ifdef ENABLE_MYSQL
             AcidDbOpInit();
             SguilOpInit();
           #endif
    Bamm@syn# make
    Bamm@syn# cd ../..; make
  Barnyard should now be built and can be installed where you prefer.
  Edit the barnyard.conf and add the following line to use the sguil plugin:
    output sguil: mysql, sensor_id 0, database sguildb, server syn, user root,\
    password dbpasswd, sguild_host syn, sguild_port 7736
  Start Barnyard:
    Bamm@syn# /usr/local/bin/barnyard -c /etc/snort/barnyard.conf -d /var/log/snort\
    -g /etc/snort/gen-msg.map -s /etc/snort/sid-msg.map -f snort.log -w /etc/snort/waldo.file


D. Start log_packets.sh

The script log_packets.sh is used to log the binary data. It is located 
in the sguil/sensor directory and should be ran on the sensor.  log_packets.sh
runs snort in 'packet logger' mode. Edit the configurations, start the script
(./log_packets.sh start), and then add an entry to the crontab to restart
the script every hour (you can change the interval based on your requirements):
  # Crontab example
  00 0-23/1 * * * /usr/local/bin/log_packets.sh restart

NOTE: By default, log_packets.sh is set up to have snort log EVERY packet on
the network. A bpf filter example is included in the script. Use bpf to tune
the amount of logging based on the available drive space. It is highly
recommended to create a seperate partion for logging data to. The sensor agent
reports currect disk stats to sguild, but the user is responsible for 
deleting/archiving old data at this time.


###########################
#Step 5: Install xscriptd.#
###########################
Xscriptd is meant to be run on the same system as sguild. Its purpose is
to get binary packet data from sensor(s) and generate a transcript using tcpflow
or forward the binary file to the client to be loaded into ethereal. 


Setting up xscriptd on a "local" system (one where snort, barnyard, sguild, and
xscriptd are all run on the same system) is fairly simple. Edit the options
at the beginning of xscriptd (don't for get to specify the correct path to
the tcl interpreter) and make sure that the LOCALSENSOR var is set to "1".

Configuring a "remote" system is a little harder. Xscriptd uses ssh and scp to
retrieve files file the remote sensor. In order for this process to work, it
needs access to a valid ssh identy file that requires no passphrase. Follow these
steps to create one:
  #Shown using dsa
  Bamm@syn# ssh-keygen -t dsa
  Generating public/private dsa key pair.
  Enter file in which to save the key (/root/.ssh/id_dsa): 
  Enter passphrase (empty for no passphrase): <Press Return Here> 
  Enter same passphrase again: <Return again, we want an empty passphrase>
  Your identification has been saved in /root/.ssh/id_dsa.
  Your public key has been saved in /root/.ssh/id_dsa.pub.
  The key fingerprint is:
  7f:39:32:c4:74:d7:f9:55:ad:a0:d3:d3:ba:2d:ba:45 drea@syn.bamm.net

Now append the public key (id_dsa.pub) to the .ssh/authorized_keys2 file on the remote
sensor. You must now ssh to the remote sensor and make sure that the user that
xscriptd will run as can log in without any interaction. You may have to specify
a path to the private identity file (id_dsa). If so, make sure you modify the options
in xscriptd to reflect this:
  # Path to different execs here. If you need to send flags then put them here also
  # set SSH "/usr/bin/ssh -p 1234"
  set SSH "/usr/bin/ssh -i /root/.ssh/sensor_key_id_dsa"
  set SCP "/usr/bin/scp" -i /root/.ssh/sensor_key_id_dsa"


############
#   DONE!  #
############
Read the USAGE for information about using sguil.tk.

Bammkkkk

